import datetime
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

from .... import crud, models, schemas
from ....api import deps
from ....services import ai_service
from ....models.vulnerability_event import VulnerabilityEvent

router = APIRouter()

@router.get("/{definition_id}", response_model=schemas.VulnerabilityDefinitionDetails)
def read_vulnerability_definition(
    *,
    db: Session = Depends(deps.get_db),
    definition_id: int,
    current_user: models.User = Depends(deps.get_current_active_user),
):
    """
    Get details and occurrences for a specific vulnerability definition.
    """
    definition = db.query(models.VulnerabilityDefinition).filter(models.VulnerabilityDefinition.id == definition_id).first()
    if not definition:
        raise HTTPException(status_code=404, detail="Vulnerability Definition not found")
    return definition

@router.post("/occurrences/{occurrence_id}/status", response_model=schemas.VulnerabilityOccurrenceDetails)
def update_occurrence_status(
    *,
    db: Session = Depends(deps.get_db),
    occurrence_id: int,
    status_in: schemas.VulnerabilityStatusUpdate,
    current_user: models.User = Depends(deps.get_current_analyst_user),
):
    """
    Update the status of a vulnerability occurrence.
    """
    occurrence = db.query(models.VulnerabilityOccurrence).filter(models.VulnerabilityOccurrence.id == occurrence_id).first()
    if not occurrence:
        raise HTTPException(status_code=404, detail="Vulnerability occurrence not found")

    occurrence.status = status_in.status
    if status_in.status == "remediated":
        occurrence.remediated_at = datetime.datetime.utcnow()
    else:
        occurrence.remediated_at = None

    event = VulnerabilityEvent(
        occurrence_id=occurrence.id,
        status_change=f"status set to {status_in.status}",
        user_id=current_user.id
    )
    db.add(occurrence)
    db.add(event)
    db.commit()
    db.refresh(occurrence)
    return occurrence

@router.post("/occurrences/{occurrence_id}/summarize", response_model=schemas.Msg)
def summarize_occurrence(
    *,
    db: Session = Depends(deps.get_db),
    occurrence_id: int,
    current_user: models.User = Depends(deps.get_current_analyst_user),
):
    """
    Generate an AI summary for a specific vulnerability occurrence.
    """
    occurrence = db.query(models.VulnerabilityOccurrence).filter(models.VulnerabilityOccurrence.id == occurrence_id).first()
    if not occurrence:
        raise HTTPException(status_code=404, detail="Vulnerability Occurrence not found")

    summary = ai_service.summarize_vulnerability(occurrence.definition)
    return {"msg": summary}
